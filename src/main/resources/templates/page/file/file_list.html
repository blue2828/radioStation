<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户列表</title>
    <link rel="shortcut icon" href="../images/radio.ico"/>
    <style type="text/css">
        .laytable-cell-1-view{
            height: 100%;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="layui-inline" style="margin:5px 0 0 5px;">
        <button id="openFrame_btn" class="layui-btn layui-btn-normal" type="button"><i class="layui-icon">&#xe67c;</i>上传</button>
    </div>
    <table class="layui-table" lay-filter="tab_filter" id="lay_tb"></table>
    <div id="tb" style="display:none;">
        <button type="button" lay-event="remove"  class="layui-btn layui-btn-danger layui-btn-mini"><i class="layui-icon">&#xe640;</i><span>删除</span></button>
        <button type="button" lay-event="download"  class="layui-btn layui-btn-normal layui-btn-mini"><i class="layui-icon">&#xe642;</i><span>编辑</span></button>
    </div>
    <div id="uploadFrame" style="display:none;">
        <div class="layui-upload">
            <button class="layui-btn layui-btn-normal" type="button"><i class="layui-icon">&#xe67c;</i>上传图片</button>
            <div class="layui-upload-list">
                <img style="width:260px;height:200px;border:1px solid #C0C0C0;" id="up_img" class="layui-upload-img">
                <p id="errText"></p>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="../../common/layui/css/layui.css" media="all">
    <script type="text/javascript" src="../../common/layui/layui.js" ></script>
    <script type="text/javascript" >
    layui.use(['table','layer','element','upload'],function(){
        var layer = layui.layer, $ = layui.jquery, table = layui.table, element = layui.element, upload = layui.upload;

        var tbOp = table.render({
            url: '../../getAllFiles?selectVersion=0',
            elem: "#lay_tb", 
            height: 400, 
            cols: [[
                {field: 'cb', checkbox: true},
                {field: 'id', sort: true, align: 'center', title: '编号', width: 100},
                {field: 'type', align: 'center', title: '文件类型', width: 100},
                {field: 'fileName', align: 'center', title: '文件名', width: 180},
                {field: 'view', align: 'center', title: '预览文件', width: 100},
                {field: 'uploadMemId', align: 'center', title: '上传人', width: 120},
                {field: 'uploadDate', align: 'center', title: '上传时间', width: 180},
                {field: 'storeAddr', sort: true, align: 'center', title: '存放地址', width: 180},
                {field: 'fileDesc', align: 'center', title: '赠词', width: 180},
                {field: 'op', align: 'center', title: '操作', width: 180, toolbar: '#tb'}
                ]], 
            page: true,
            done: (res, page, count) => {
                $("[data-field='view']").each((index, value) => {
                    if (index == 0)
                        return true;
                    let storeAddr = $(value).next().next().next().text();
                    let fileType = storeAddr.substring(storeAddr.indexOf(".") + 1);
                    switch (fileType) {
                        case "pdf" :
                            $(value).html("<img style='width: 100px;' onclick='preview(this)' src='../../images/pdf.jpeg' class='imgHeader'>");
                            break;
                        case "txt" :
                            $(value).html("<img style='width: 100px;' onclick='preview(this)' src='../../images/txt.jpg' class='imgHeader'>");
                            break;
                        default :
                            let strFilter=".jpeg|.gif|.jpg|.png|.bmp|.pic|";
                            let arr = strFilter.split("|", 6);
                            $.each(arr, (item, itemValue) => {
                                if ("." + fileType == itemValue) {
                                    $(value).html("<img style='width: 100px;' onclick='preview(this)' src='../../images/pic.jpg' class='imgHeader'>");
                                    return false;
                                }else {
                                    item == 5 ? $(value).html("<img style='width: 100px;' onclick='preview(this)' src='../../images/mp3.jpg' class='imgHeader'>") :
                                        undefined;
                                }
                            });

                    }
                });
            }
        });

        window.preview = function (obj) {
                let storeAddr = $(obj).parent().next().next().next().text();
                let fileType = storeAddr.substring(storeAddr.indexOf(".") + 1);
                switch (fileType) {
                    case "pdf" :
                        openFrame("<iframe id=\"pdfIframe\" width=\"100%\" height=\"768\"></iframe>", [$(window).width() - 100 + 'px', $(window).height() - 50 + 'px']);
                        break;
                    case "txt" :
                        $(value).html("<img style='width: 100px;' src='../../images/txt.jpg' class='imgHeader'>");
                        break;
                    default :
                        let strFilter=".jpeg|.gif|.jpg|.png|.bmp|.pic|";
                        let arr = strFilter.split("|", 6);
                        $.each(arr, (item, itemValue) => {
                            if ("." + fileType == itemValue) {
                                $(value).html("<img style='width: 100px;' src='../../images/pic.jpg' class='imgHeader'>");
                                return false;
                            }else {
                                item == 5 ? $(value).html("<img style='width: 100px;' src='../../images/mp3.jpg' class='imgHeader'>") :
                                    undefined;
                            }
                        });

                }
        }
        table.on("tool(tab_filter)", function(obj){
            var event = obj.event;
            var data = obj.data;
            if(event == 'remove'){
                layer.confirm('是否要删除？', {icon: 3, title: '系统提示'}, function(index){
                    $.post('../../delMember', {'idArr': data.id}, function(res){
                        if(res.success) {
                            layer.msg('删除成功');
                            layer.close(index);
                            tbOp.reload({
                                url:"../../getMemberInfo"
                            });
                        }
                        else{
                            layer.msg(res.errMsg, {icon:5, time:800});
                            layer.close(index);
                            tbOp.reload({
                                url: "../../getMemberInfo"
                            });
                        }
                    }, 'json');
                });
            }
        });
        function openFrame (content, area) {
            layer.open({
                content: $(content).html(),
                type: 1,
                area: [area[0], area[1]]
            });
        }
    });
</script>
</body>
</html>